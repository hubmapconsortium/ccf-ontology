<!doctype html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.babylonjs.com/viewer/babylon.viewer.js"></script>
    <style>
      body {
        font-family: sans-serif;
      }
      .model-container {
        width: 660px;
        height: 460px;
        display: none;
      }
    </style>
    <title>Cell Type Finder</title>
  </head>
  <body>
    <h1>Cell Type Finder</h1>
    <form>
      <label for="biomarkers">Biomarkers (separated by commas):</label><br/>
      <textarea id="biomarkers" name="biomarkers" rows="4" cols="80"></textarea><br/>
      <label for="examples-dropdown">Use example: </label>
      <select type="text" id="examples-dropdown" name="examples">
        <option value="">--- Please select an example ---</option>
        <option value="DCN,GSN,PDGFRA">DCN, GSN, PDGFRA</option>
        <option value="VSX2,FOXD1">VSX2, FOXD1</option>
        <option value="PECAM1">PECAM1</option>
        <option value="SATB2,CRYAB,SPP1,VCAM1">SATB2, CRYAB, SPP1, VCAM1</option>
      </select><br/>
      <button type="button" id="find">Find</button>&nbsp;&nbsp;
      <label id="message" style="color:red;"></label>
    </form>
    <br/><br/>
    <div id="result-container" class="result-container" style="display:none;">
      <label for="cell-type">Cell type:</label><br/>
      <select type="text" id="cell-type-dropdown" name="cell-type"></select><br/>
      <label for="anatomical-structures">The locations of the cell type:</label><br/>
      <textarea id="anatomical-structures" name="anatomical-structures" rows="5" cols="80" disabled></textarea><br/>
      <div id="model-container" class="model-container">
        <label for="as-model"></label>Organ visual:<br/>
        <babylon id="as-model"></babylon>
      </div><br/>
      <textarea id="reference-organs" name="reference-organs" row="5" cols="80" disabled></textarea>
    </div>

    <script>
      $('#find').click(function() {
        $('#cell-type-dropdown').empty();
        $('#anatomical-structures').val("");
        $('#result-container').hide();
        $('#model-container').hide();
        $('#message').text("Processing, please wait...")
        $.getJSON('http://localhost:3000/getCellType', { symbols : $('#biomarkers').val() },
          function(response) {
            if (response.length == 0) {
              $('#message').text("No result");
              $('#result-container').hide();
              return;
            }
            $('#message').text("")
            $('#result-container').show();
            $.each(response, function (index, value) {
              $('#cell-type-dropdown').append($('<option></option>')
                .attr('value', JSON.stringify(value))
                .text(value['cell_type']));
            });
            var anatomical_structures = response[0]['anatomical_structures'];
            var glb_files = response[0]['glb_files'];
            var reference_organs = response[0]['reference_organs'];

            updateAnatomicalStructuresTextArea(anatomical_structures);
            updateOrganVisualViewer(glb_files);
            updateReferenceOrganTextArea(reference_organs);
          });
      });

      $('#cell-type-dropdown').change(function(e) {
          var value = JSON.parse(e.target.value);
          var anatomical_structures = value['anatomical_structures'];
          var glb_files = value['glb_files'];
          var reference_organs = value['reference_organs'];

          updateAnatomicalStructuresTextArea(anatomical_structures);
          updateOrganVisualViewer(glb_files);
          updateReferenceOrganTextArea(reference_organs);
      });

      $('#biomarkers').on('input', function(e) {
        $('#examples-dropdown').val($('#examples-dropdown option:first').val());
      });

      $('#examples-dropdown').change(function(e) {
        updateBiomarkersTextArea(e.target.value);
      });

      function updateBiomarkersTextArea(value) {
        $('#biomarkers').val(value);
      }

      function updateAnatomicalStructuresTextArea(value) {
        $('#anatomical-structures').val(value);
      }

      function updateOrganVisualViewer(value) {
        var first_glb_file = getFirstGlbFile(value);
        if (first_glb_file != null) {
          $('#model-container').show();
          loadModel(first_glb_file);
        } else {
          $('#model-container').hide();
        }
      }

      function updateReferenceOrganTextArea(value) {
        $('#reference-organs').val(value);
      }

      function loadModel(glb_file) {
        BabylonViewer.viewerManager
          .getViewerPromiseById("as-model")
          .then(function (viewer) {
            viewer.loadModel({
             url: glb_file
            });
          });
      }

      function getFirstGlbFile(glb_files) {
        var first_glb_file = null;
        if (glb_files != null) {
          first_glb_file = glb_files.split(", ")[0];
        }
        return first_glb_file;
      }
    </script>
  </body>
</html>